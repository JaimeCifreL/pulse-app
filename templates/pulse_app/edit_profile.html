{% extends 'base.html' %}

{% block title %}Configuración del Perfil - Pulse{% endblock %}

{% block page_title %}Editar Perfil{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <div class="settings-header">
        <h1 class="page-main-title">Configuración del Perfil</h1>
        <a href="{% url 'profile' username=user.username %}" class="btn btn-secondary">Cancelar</a>
    </div>

    {% if error %}
        <div class="alert alert-error">
            {{ error }}
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="edit-profile-form">
        {% csrf_token %}

        <div class="form-section">
            <h2>Información Personal</h2>

            <!-- Foto de perfil -->
            <div class="form-group profile-photo-section">
                <label>Foto de Perfil</label>
                <div class="photo-upload-container">
                    <div class="current-photo">
                        {% if user.profile_photo %}
                            <img src="{{ user.profile_photo.url }}" alt="Foto de perfil" id="photo-preview">
                        {% else %}
                            <div class="profile-photo-placeholder" id="photo-preview">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                            </div>
                        {% endif %}
                    </div>
                    <div class="photo-upload-actions">
                        <input type="file" id="profile_photo" name="profile_photo" accept="image/*" class="file-input">
                        <label for="profile_photo" class="btn btn-primary btn-sm">
                            {% if user.profile_photo %}Cambiar foto{% else %}Subir foto{% endif %}
                        </label>
                        {% if user.profile_photo %}
                            <button type="button" onclick="removePhoto()" class="btn btn-secondary btn-sm">Eliminar foto</button>
                        {% endif %}
                        <small class="form-help">JPG, PNG o GIF. Máximo 5MB.</small>
                    </div>
                </div>
            </div>

            <!-- Nombre visible -->
            <div class="form-group">
                <label for="display_name">Nombre Visible</label>
                <input type="text" id="display_name" name="display_name" value="{{ user.display_name|default:'' }}" 
                       class="form-input" maxlength="100">
                <small class="form-help">Tu nombre real o como quieres que te llamen</small>
            </div>

            <!-- Nombre de usuario -->
            <div class="form-group">
                <label for="username">Nombre de Usuario / @handle</label>
                <div class="username-input">
                    <span class="username-prefix">@</span>
                    <input type="text" id="username" name="username" value="{{ user.username }}" 
                           class="form-input username-field" required maxlength="150">
                </div>
                <small class="form-help">Tu identificador único en Pulse</small>
            </div>

            <!-- Email -->
            <div class="form-group">
                <label for="email">Correo Electrónico</label>
                <input type="email" id="email" name="email" value="{{ user.email }}" 
                       class="form-input" required>
                <small class="form-help">No será visible públicamente</small>
            </div>

            <!-- Bio -->
            <div class="form-group">
                <label for="bio">Biografía</label>
                <textarea id="bio" name="bio" class="form-textarea" 
                          maxlength="500" rows="4">{{ user.bio|default:'' }}</textarea>
                <small class="form-help" id="bio-counter">{{ user.bio|length|default:0 }} / 500 caracteres</small>
            </div>

            <!-- Fecha de nacimiento -->
            <div class="form-group">
                <label for="date_of_birth">Fecha de Nacimiento</label>
                <input type="date" id="date_of_birth" name="date_of_birth" 
                       value="{% if user.date_of_birth %}{{ user.date_of_birth|date:'Y-m-d' }}{% endif %}" 
                       class="form-input">
                <small class="form-help">Esta información solo es visible para ti</small>
            </div>

            <!-- Género -->
            <div class="form-group">
                <label for="gender">Género (Opcional)</label>
                <select id="gender" name="gender" class="form-input">
                    <option value="">Prefiero no especificar</option>
                    <option value="Masculino" {% if user.gender == 'Masculino' %}selected{% endif %}>Masculino</option>
                    <option value="Femenino" {% if user.gender == 'Femenino' %}selected{% endif %}>Femenino</option>
                    <option value="No binario" {% if user.gender == 'No binario' %}selected{% endif %}>No binario</option>
                    <option value="Otro" {% if user.gender == 'Otro' %}selected{% endif %}>Otro</option>
                </select>
            </div>

            <!-- Pronombres -->
            <div class="form-group">
                <label for="pronouns">Pronombres (Opcional)</label>
                <input type="text" id="pronouns" name="pronouns" value="{{ user.pronouns|default:'' }}" 
                       class="form-input" maxlength="50" placeholder="ej: él/ella, elle, they/them">
                <small class="form-help">Cómo te gustaría que otros se refieran a ti</small>
            </div>
        </div>

        <div class="form-section">
            <h2>Privacidad</h2>

            <!-- Cuenta privada -->
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="is_private" {% if user.is_private %}checked{% endif %}>
                    <span>Cuenta Privada</span>
                </label>
                <small class="form-help">Solo tus seguidores aprobados podrán ver tus publicaciones</small>
            </div>
        </div>

        <div class="form-section">
            <h2>Apariencia</h2>
            
            <!-- Tema oscuro/claro -->
            <div class="form-group">
                <label>Tema de la aplicación</label>
                <div class="theme-selector">
                    <button type="button" class="theme-option" data-theme="light" id="theme-light">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                            <line x1="1" y1="12" x2="3" y2="12"></line>
                            <line x1="21" y1="12" x2="23" y2="12"></line>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                        </svg>
                        <span>Claro</span>
                    </button>
                    
                    <button type="button" class="theme-option" data-theme="dark" id="theme-dark">
                        <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                        <span>Oscuro</span>
                    </button>
                    
                    <button type="button" class="theme-option" data-theme="auto" id="theme-auto">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="3" x2="9" y2="21"></line>
                        </svg>
                        <span>Auto</span>
                    </button>
                </div>
                <small class="form-help">Elige cómo quieres ver Pulse</small>
            </div>
        </div>

        <div class="form-section">
            <h2>Cambiar Contraseña</h2>
            <small class="form-help">Deja estos campos vacíos si no quieres cambiar tu contraseña</small>

            <!-- Nueva contraseña -->
            <div class="form-group">
                <label for="new_password">Nueva Contraseña</label>
                <input type="password" id="new_password" name="new_password" class="form-input">
                <small class="form-help">Mínimo 8 caracteres</small>
            </div>

            <!-- Confirmar contraseña -->
            <div class="form-group">
                <label for="confirm_password">Confirmar Nueva Contraseña</label>
                <input type="password" id="confirm_password" name="confirm_password" class="form-input">
            </div>
        </div>

        <div class="form-actions">
            <a href="{% url 'profile' username=user.username %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
</div>

<script>
    // Función para eliminar foto de perfil
    function removePhoto() {
        if (confirm('¿Estás seguro de que quieres eliminar tu foto de perfil?')) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '';
            
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            
            const removeInput = document.createElement('input');
            removeInput.type = 'hidden';
            removeInput.name = 'remove_photo';
            removeInput.value = 'true';
            
            form.appendChild(csrfInput);
            form.appendChild(removeInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // Preview de foto de perfil
    document.getElementById('profile_photo').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validar tamaño (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es demasiado grande. Máximo 5MB.');
                this.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const preview = document.getElementById('photo-preview');
                if (preview.tagName === 'IMG') {
                    preview.src = event.target.result;
                } else {
                    const img = document.createElement('img');
                    img.src = event.target.result;
                    img.id = 'photo-preview';
                    preview.parentNode.replaceChild(img, preview);
                }
            };
            reader.readAsDataURL(file);
        }
    });

    // Contador de caracteres para bio
    document.getElementById('bio').addEventListener('input', function() {
        const counter = document.getElementById('bio-counter');
        counter.textContent = this.value.length + ' / 500 caracteres';
    });

    // ========== SELECTOR DE TEMA ==========
    // El tema se maneja automáticamente por theme.js
    // Solo necesitamos inicializar el estado activo al cargar
    
    document.addEventListener('DOMContentLoaded', function() {
        // Esperar a que theme.js cargue
        setTimeout(function() {
            if (typeof getThemePreference === 'function') {
                const currentPreference = getThemePreference();
                document.querySelectorAll('.theme-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeBtn = document.getElementById(`theme-${currentPreference}`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
            }
        }, 100);
    });

    // Allow back navigation in edit profile
    if (window.innerWidth <= 768) {
        document.body.style.overscrollBehaviorX = 'auto';
    }
</script>

<style>
    .theme-selector {
        display: flex;
        gap: 12px;
        margin-top: 10px;
    }

    .theme-option {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: rgba(255, 255, 255, 0.7);
    }

    .theme-option:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .theme-option.active {
        background: rgba(255, 107, 157, 0.2);
        border-color: var(--accent-color, #ff6b9d);
        color: var(--accent-color, #ff6b9d);
    }

    .theme-option svg {
        stroke-width: 2;
    }

    .theme-option span {
        font-size: 14px;
        font-weight: 500;
    }

    @media (max-width: 768px) {
        .theme-selector {
            flex-direction: row;
        }
        
        .theme-option {
            padding: 16px 12px;
        }
    }
</style>
{% endblock %}
